# CIH Analysis Pipeline

This repository contains the analysis code for the **Commission on Investing in Health (CIH)** paper. It wraps around the [FairChoices-v3](https://github.com/...) model, which must be cloned as a sibling directory.

## Repository structure

```
Desktop/
├── CIH/                        ← this repo
│   ├── config.R                # Shared parameters (sourced by all scripts)
│   ├── 1_Run_CIH.R             # Stage 1 & 2: run the CIH model for all countries
│   ├── 2_CIH_Paper_Plots.R     # Generate all paper figures and save to report/plots.Rda
│   ├── fxn/                    # CIH-specific model functions
│   │   ├── run_cih_funcs.R
│   │   └── project_pop_cih.R
│   ├── input/                  # Input data files
│   │   ├── country_region_mapping.csv
│   │   ├── Intervention_map.csv
│   │   ├── intervention_map.csv
│   │   ├── cih_modules.csv
│   │   └── gni.csv
│   ├── output/                 # Model outputs (git-ignored)
│   │   ├── fulldf/
│   │   ├── fullq70/
│   │   │   └── ids/
│   │   └── fullcost/
│   │       └── ids/
│   └── report/
│       ├── Results_Report.Rmd  # Interactive R Markdown report (Shiny runtime)
│       └── plots.Rda           # Saved plot objects (git-ignored, generated by script 2)
│
└── FairChoices-v3/             ← external repo (not part of this repo)
    ├── config/
    ├── scripts/
    ├── data/
    └── ...
```

## How to run

Scripts must be opened in **RStudio** and run with the file active (they use
`rstudioapi::getActiveDocumentContext()` to locate the project root and set the
working directory to `FairChoices-v3/`).

### Step 1 — Run the CIH model

Open and run `1_Run_CIH.R`.

This script runs in two sequential stages:

- **Stage 1 (parallel):** For each country and intervention ID, runs the CIH
  model and writes per-ID `.fst` files to `output/fullq70/ids/` and
  `output/fullcost/ids/`. The cluster is restarted every 10 countries to
  manage memory.
- **Stage 2 (sequential):** For each country, runs the full-package model
  (all IDs, coverage target = 1) and writes country-level `.fst` files to
  `output/fulldf/`, `output/fullq70/`, and `output/fullcost/`.

Timing results are saved to `output/timing_results.fst`.

### Step 2 — Generate paper plots

Open and run `2_CIH_Paper_Plots.R`.

Reads the model outputs from Step 1, computes all derived indicators (life
tables, ICERs, regional aggregates), and saves the required plot objects to
`report/plots.Rda`.

### Step 3 — Render the report

Open `report/Results_Report.Rmd` in RStudio and click **Run Document** (the
report uses `runtime: shiny`). It loads `report/plots.Rda` produced in Step 2.

## Key inputs

| File | Description |
|------|-------------|
| `input/country_region_mapping.csv` | ISO3 codes and world region assignments |
| `input/Intervention_map.csv` | Intervention IDs, modules, categories, package status |
| `input/cih_modules.csv` | CIH module → condition name mapping |
| `input/gni.csv` | GNI per capita by country (2023, current US$) |
| `FairChoices-v3/data/db/offline_<ISO3>.rda` | Pre-computed per-country model inputs |
| `FairChoices-v3/data/wb/2024/country2024.rda` | World Bank country metadata |
| `FairChoices-v3/data/taxonomy/taxGroups.rda` | Disease taxonomy groupings |

## Dependencies

```r
install.packages(c(
  "foreach", "doParallel", "dplyr", "tidyr", "data.table", "fst",
  "ggplot2", "sf", "rnaturalearth", "countrycode", "readxl",
  "highcharter", "stringr", "purrr", "shiny", "shinythemes",
  "shinydashboard", "shinycssloaders", "rmdformats",
  "DiagrammeR", "DiagrammeRsvg", "htmltools", "knitr", "kableExtra",
  "jsonlite"
))
```

## Notes

- `config.R` is the single source of truth for shared parameters (`iso3s`,
  `no_vmc_countries`, `idlist_base`, `region_colors`, etc.). Do not redefine
  these in individual scripts.
- Large output files (`.fst`, `.rda`, `.Rda`) are git-ignored. Collaborators
  need to run Steps 1 and 2 to regenerate them.
- The `FairChoices-v3` directory is an independent repository maintained
  separately. This repo only reads from it; it does not modify it.
